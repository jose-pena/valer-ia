<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>valerIA Chat</title>
  <style>
    body { margin:0; font:14px system-ui,-apple-system,Segoe UI,Roboto; background:#0A1628; color:#fff; }
    .wrap { height:100vh; display:flex; flex-direction:column; }
    header { padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06); }
    header .t { font-weight:800; }
    header .s { opacity:.75; font-size:12px; margin-top:2px; }
    .msgs { flex:1; overflow:auto; padding:12px; }
    .m { display:flex; margin:8px 0; }
    .m.user { justify-content:flex-end; }
    .b { max-width:85%; padding:10px 12px; border-radius:14px; line-height:1.35; white-space:pre-wrap; }
    .m.user .b { background:#C9A84C; color:#0A1628; }
    .m.bot .b { background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.10); }
    form { display:flex; gap:8px; padding:10px 12px; border-top:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.12); }
    input { flex:1; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.08); color:#fff; padding:10px 12px; outline:none; }
    input::placeholder { color:rgba(255,255,255,.6); }
    button { border:0; border-radius:12px; padding:10px 12px; font-weight:800; cursor:pointer; background:#C9A84C; color:#0A1628; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="t">valerIA</div>
      <div class="s">Responde en segundos</div>
    </header>

    <div class="msgs" id="msgs"></div>

    <form id="form">
      <input id="input" placeholder="Write your message…" autocomplete="off" />
      <button type="submit">Send</button>
    </form>
  </div>

  <script>
    const WEBHOOK_URL = "https://n8n.srv1419047.hstgr.cloud/webhook/f36ce9f3-3dcd-4c86-89fc-b936a22f44b1";
    const msgs = document.getElementById("msgs");
    const form = document.getElementById("form");
    const input = document.getElementById("input");

    const state = { sessionId: localStorage.getItem("b44_sessionId") || "" };

    function addMsg(text, who) {
      const row = document.createElement("div");
      row.className = "m " + who;
      const bubble = document.createElement("div");
      bubble.className = "b";
      bubble.textContent = text;
      row.appendChild(bubble);
      msgs.appendChild(row);
      msgs.scrollTop = msgs.scrollHeight;
      return row;
    }

    addMsg("Hi! I'm valerIA. How can I help?", "bot");

    async function ask(message) {
      const payload = state.sessionId ? { message, sessionId: state.sessionId } : { message };
      const res = await fetch(WEBHOOK_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error("HTTP " + res.status);
      return res.json();
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const text = (input.value || "").trim();
      if (!text) return;
      input.value = "";
      addMsg(text, "user");

      const loading = addMsg("…", "bot");

      try {
        const data = await ask(text);
        loading.remove();

        if (data.sessionId) {
          state.sessionId = String(data.sessionId);
          localStorage.setItem("b44_sessionId", state.sessionId);
        }

        addMsg(data.reply ?? data.output ?? "No reply received.", "bot");
      } catch (err) {
        loading.remove();
        addMsg("Connection error. Please try again.", "bot");
        console.error(err);
      }
    });
  </script>
</body>
</html>
